<!-- ec185e7c-9a98-4a18-af93-fb6e26ca1545 a03715fc-b54b-4409-a1ee-e7013e6c6126 -->
# ScienceQA RAG 论文级项目升级计划

## 一、Jina v2 Embedding模型训练

### 1.1 训练框架搭建

- **文件**: `src/training/jina_trainer.py`
  - 实现Jina v2 base 0.2b的fine-tuning框架
  - 支持对比学习（Contrastive Learning）
  - 实现ScienceQA数据集的监督学习
  - 支持硬负样本挖掘（Hard Negative Mining）
  - 实现训练循环、验证、checkpoint保存

- **文件**: `src/training/data_preparation.py`
  - 准备训练数据：问题-答案对、问题-相关文档对
  - 生成正负样本对（positive/negative pairs）
  - 实现数据增强（Data Augmentation）
  - 支持批量数据加载和预处理

- **文件**: `src/training/training_config.py`
  - 训练超参数配置（学习率、batch size、epochs等）
  - 优化器配置（AdamW、学习率调度）
  - 损失函数配置（对比损失、三元组损失等）

### 1.2 Jina模型集成

- **文件**: `src/rag/embeddings/jina_embedding.py`
  - 创建JinaEmbedding类，支持jina-ai/jina-embeddings-v2-base-en
  - 实现与LangChain兼容的接口
  - 支持加载训练后的模型权重
  - 实现批量编码和GPU加速

- **文件**: `config.py`
  - 添加JINA_MODEL_PATH（训练后模型路径）
  - 添加JINA_BASE_MODEL（基础模型：jina-ai/jina-embeddings-v2-base-en）
  - 添加训练相关配置（训练数据路径、输出目录等）

### 1.3 训练脚本和工具

- **文件**: `scripts/train_jina.py`
  - 主训练脚本
  - 支持命令行参数（数据路径、模型路径、超参数等）
  - 实现训练进度监控和日志记录
  - 支持断点续训

- **文件**: `scripts/prepare_training_data.py`
  - 从ScienceQA数据集生成训练数据
  - 生成正负样本对
  - 数据格式转换（JSON/CSV）

## 二、多模态推理和生成能力提升

### 2.1 多模态检索增强

- **文件**: `src/rag/multimodal_retriever.py`
  - 实现图像-文本联合检索
  - 集成CLIP等视觉embedding模型
  - 实现混合检索策略（文本检索 + 视觉检索）
  - 支持多模态相似度计算和融合

- **文件**: `src/multimodal/vision_encoder.py`
  - 实现视觉编码器（CLIP、BLIP等）
  - 支持图像特征提取和向量化
  - 实现图像-文本对齐（Image-Text Alignment）

### 2.2 多模态上下文融合

- **文件**: `src/rag/multimodal_fusion.py`
  - 实现多模态上下文融合策略
  - 支持注意力机制融合（Attention-based Fusion）
  - 实现图像描述与检索文档的联合编码
  - 优化多模态prompt构建

- **文件**: `src/rag/rag_system.py` (增强)
  - 增强answer_with_rag方法
  - 实现多模态检索流程
  - 优化图像描述与文本上下文的融合
  - 支持多模态prompt生成

### 2.3 LLaVA模型优化

- **文件**: `src/multimodal/llava_processor.py` (增强)
  - 优化图像描述生成策略
  - 实现更细粒度的图像理解（对象、关系、过程）
  - 支持多轮对话式图像理解
  - 实现图像描述质量评估

## 三、评估和实验体系

### 3.1 评估指标

- **文件**: `src/evaluation/metrics.py`
  - 准确率（Accuracy）
  - 检索质量：MRR、NDCG@K、Recall@K、Precision@K
  - 生成质量：BLEU、ROUGE、BERTScore
  - 多模态评估：图像理解准确率、多模态匹配度

- **文件**: `src/evaluation/evaluator.py`
  - 实现ScienceQARAGEvaluator类
  - 支持批量评估和单样本评估
  - 生成详细的评估报告（JSON/CSV/LaTeX）

### 3.2 对比实验

- **文件**: `src/experiments/embedding_comparison.py`
  - Jina v2（训练后）vs Jina v2（原始）vs 现有embedding
  - 不同训练策略对比
  - 消融实验（Ablation Study）

- **文件**: `src/experiments/multimodal_ablation.py`
  - 多模态RAG vs 纯文本RAG
  - 不同融合策略对比
  - LLaVA描述质量对性能的影响

### 3.3 结果可视化

- **文件**: `scripts/visualize_results.py`
  - 生成性能对比图表
  - 检索质量可视化
  - 训练曲线可视化
  - 生成论文用图表（PDF/PNG）

## 四、命令行工具扩展

### 4.1 训练命令

- **文件**: `main.py` (扩展)
  - `train_jina`: 训练Jina embedding模型
  - `prepare_data`: 准备训练数据
  - `evaluate`: 运行评估
  - `compare_embeddings`: 对比不同embedding模型
  - `multimodal_experiment`: 运行多模态实验

## 五、配置和文档

### 5.1 配置文件

- **文件**: `config.py`
  - 训练配置（学习率、batch size、epochs、优化器）
  - 评估配置（评估集路径、指标选择）
  - 多模态配置（视觉模型选择、融合策略）
  - 实验配置（实验名称、输出目录）

### 5.2 文档

- **文件**: `README.md` (更新)
  - 添加训练说明
  - 添加多模态功能说明
  - 添加评估和实验说明

- **文件**: `TRAINING.md`
  - Jina模型训练详细指南
  - 数据准备说明
  - 超参数调优建议

- **文件**: `EXPERIMENTS.md`
  - 实验设计文档
  - 结果分析和讨论
  - 可复现性说明

## 六、依赖管理

### 6.1 新增依赖

- **文件**: `requirements.txt`
  - `jina-ai`或直接使用transformers加载Jina模型
  - `clip-by-openai`或`transformers`（CLIP模型）
  - `sacrebleu`、`rouge-score`（评估指标）
  - `matplotlib`、`seaborn`（可视化）
  - `tensorboard`（训练监控）

## 实施优先级

**Phase 1: 核心训练框架（1-2周）**
1. 集成Jina v2 base模型
2. 实现训练数据准备工具
3. 搭建训练框架基础结构

**Phase 2: 训练和优化（2-3周）**
4. 实现训练循环和验证
5. 超参数调优
6. 模型评估和对比

**Phase 3: 多模态增强（2-3周）**
7. 实现多模态检索
8. 优化多模态融合策略
9. LLaVA优化

**Phase 4: 评估和论文准备（1-2周）**
10. 完整评估体系
11. 对比实验
12. 结果可视化和文档

## 关键技术点

1. **Jina模型训练**:
   - 使用对比学习（Contrastive Learning）
   - 正样本：问题-正确答案对、问题-相关文档对
   - 负样本：问题-错误答案对、问题-不相关文档对
   - 损失函数：InfoNCE Loss或Triplet Loss

2. **多模态检索**:
   - 文本检索：使用训练后的Jina embedding
   - 视觉检索：使用CLIP提取图像特征
   - 融合策略：加权融合、学习融合权重

3. **评估标准**:
   - 参考ScienceQA官方评估方法
   - 准确率、检索质量、生成质量

### To-dos

- [ ] 集成Jina v2 base模型，创建JinaEmbedding类并实现LangChain兼容接口
- [ ] 实现训练数据准备工具，生成正负样本对
- [ ] 搭建Jina模型fine-tuning训练框架
- [ ] 实现训练循环、验证和checkpoint保存
- [ ] 实现多模态检索增强，支持图像-文本联合检索
- [ ] 实现多模态上下文融合策略
- [ ] 优化LLaVA图像描述生成
- [ ] 实现评估指标模块（准确率、MRR、NDCG、BLEU等）
- [ ] 创建ScienceQARAGEvaluator评估类，支持批量评估
- [ ] 实现embedding模型对比实验框架
- [ ] 实现多模态消融实验
- [ ] 实现实验结果记录和可视化系统
- [ ] 更新README和创建TRAINING.md、EXPERIMENTS.md文档

